# API

A number of API endpoints are available under the `/api` route, with interactive
documentation at `/api/docs`.

## Authentication

All API endpoints under `/api` (except `/api/healthcheck`) require HMAC-SHA256 authentication.

### Header Format

```
Authorization: HMAC sig={base64_signature}
```

### Generating HMAC Signatures

The signature is computed from the raw request body:

**Ruby:**
```ruby
body = { member_id: "123" }.to_json
signature = Base64.strict_encode64(
  OpenSSL::HMAC.digest("sha256", ENV["API_SECRET_KEY"], body)
)
```

**Bash (curl POST):**
```bash
BODY='{"member_id":"123"}'
SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$API_SECRET_KEY" -binary | base64)
curl -X POST http://localhost:3000/api/certifications \
  -H "Content-Type: application/json" \
  -H "Authorization: HMAC sig=$SIG" \
  -d "$BODY"
```

**Bash (curl GET):**
```bash
# For GET requests (no body), the signature is computed from an empty string
SIG=$(echo -n "" | openssl dgst -sha256 -hmac "$API_SECRET_KEY" -binary | base64)
curl -X GET http://localhost:3000/api/certifications/{id} \
  -H "Authorization: HMAC sig=$SIG"
```

### Testing with RSpec

Use the `hmac_auth_headers` helper provided by `Strata::Testing::ApiAuthHelpers`:

```ruby
post api_certifications_url,
     params: body,
     headers: hmac_auth_headers(body: body, secret: Rails.configuration.api_secret_key)
```

For detailed security architecture, see [API Security Documentation](/docs/architecture/api-security/api-security.md).

## Stability

During the current period of initial active development, there are no stability
guarantees for the API.

## Development

### Documenting endpoints

The project uses [OasRails](https://github.com/a-chacon/oas_rails) for OpenAPI
spec generation. Project configuration of the documentation and tool is at
`/reporting-app/config/initializers/oas_rails.rb`.

Any controller method exposed on a route under the `/api` scope will
automatically be included in the documentation, but given the current project
setup, often won't display as you'd really want, so you should at least provide
`@summary` and `@tags` tags on the methods exposed:

```ruby
def FooController
  # @summary Create a Foo record
  # @tags foo
  def @create
  end
end
```

Via OasRails, for simple methods, the request and response types will be
automatically detected and added to the documenation. If you want to be
explicit, you can reference ActiveRecord models directly:

```ruby
def FooController
  # @request_body The Foo data. [!Foo]
  # @response Created Foo.(201) [Foo]
  def create
    # do stuff
  end
end
```

Or you can use type strings to document the request and response models where
present:

```ruby
def FooController
  # @request_body The Foo data. [!Hash { foo_param: String, foo_other: Integer }]
  def create
    # do stuff
  end
end
```

But that can often not be quite expressive enough to capture the specifics of
the models, or the same models may be used in multiple places, so you should
create schemas by hand in `/reporting-app/lib/assets/oas.json`, and reference
them where used (including pointing to examples):

```ruby
def FooController
  # @request_body The Foo data. [Reference:#/components/schemas/FooCreateRequestBody]
  # @request_body_example Fancy foo [Reference:#/components/schemas/FooCreateRequestBody/examples/fancy]
  # @request_body_example Simple foo [Reference:#/components/schemas/FooCreateRequestBody/examples/simple]
  # @response Created Foo.(201) [Reference:#/components/schemas/FooResponseBody]
  # @response User error.(400) [Reference:#/components/schemas/ErrorResponseBody]
  def create
    # do stuff
  end
end
```


### Testing endpoints

To ensure the API endpoints match their documentation, use
[OpenapiContracts](https://github.com/mkon/openapi_contracts) in the endpoint
tests. Just add `expect(response).to match_openapi_doc(OPENAPI_DOC)` to tests,
like:

```ruby
RSpec.describe "/foo", type: :request do
  describe "GET /api/foo" do
    it "renders a successful response" do
      foo = create(:foo)
      get api_foo_url(foo)
      expect(response).to be_successful
      # ...your usual tests...

      # additionally ensure this scenario matches the spec
      expect(response).to match_openapi_doc(OPENAPI_DOC)
    end
  end
end
```

The tests run against a snapshot of the OpenAPI spec generated by the make
command: `make openapi-spec`. If you change any API endpoints or OpenAPI spec
things, ensure you've regenerated the spec before running the tests.
